--- radvd-1.1/radvdump.c	2007-06-25 13:42:10.000000000 +0200
+++ radvd-1.1/radvdump-es.c	2008-09-23 23:29:38.000000000 +0200
@@ -39,6 +39,25 @@ void usage(void);
 void print_ff(unsigned char *, int, struct sockaddr_in6 *, int, unsigned int, int);
 void print_preferences(int);
 
+/* eager switch code - begin */
+
+typedef struct
+{
+        unsigned int if_index;
+        char if_name[IFNAMSIZ];
+        char prefix[INET6_ADDRSTRLEN];
+        unsigned int prefix_len;
+        char router_addr[INET6_ADDRSTRLEN];
+} ra_record;
+
+ra_record rar;
+ra_record *ra_cache[];
+int ra_cache_size = 0;
+
+void eager_switch(ra_record *last_ra);
+
+/* eager switch code - end */
+
 int
 main(int argc, char *argv[])
 {
@@ -131,7 +150,16 @@ main(int argc, char *argv[])
 				/* not yet */	
 			}
 			else if (icmph->icmp6_type == ND_ROUTER_ADVERT)
-				print_ff(msg, len, &rcv_addr, hoplimit, (unsigned int)pkt_info->ipi6_ifindex, edefs);
+
+/* eager switch code - begin */
+
+                        {
+                                print_ff(msg, len, &rcv_addr, hoplimit, (unsigned int)pkt_info->ipi6_ifindex, edefs);
+                                eager_switch(&rar);
+                        }
+
+/* eager switch code - end */
+
         	}
 		else if (len == 0)
        	 	{
@@ -162,7 +190,20 @@ print_ff(unsigned char *msg, int len, st
 	printf("#\n# radvd configuration generated by radvdump %s\n", VERSION);
 	printf("# based on Router Advertisement from %s\n", addr_str);
 	if_indextoname(if_index, if_name);
-	printf("# received by interface %s\n", if_name);
+
+/* eager switch code - begin */
+
+        time_t rawtime;
+
+        time(&rawtime);
+        printf("# received by interface %s at %s \n", if_name, ctime(&rawtime));
+
+        rar.if_index = if_index;
+        strcpy(rar.if_name, if_name);
+        strcpy(rar.router_addr, addr_str);
+
+/* eager switch code - end */
+
 	printf("#\n\ninterface %s\n{\n\tAdvSendAdvert on;\n", if_name);
 
 	printf("\t# Note: {Min,Max}RtrAdvInterval cannot be obtained with radvdump\n");
@@ -340,6 +381,12 @@ print_ff(unsigned char *msg, int len, st
 				
 			printf("\n\tprefix %s/%d\n\t{\n", prefix_str, pinfo->nd_opt_pi_prefix_len);
 
+/* eager switch code - begin */ 
+
+                        sprintf(rar.prefix, "%s/%d", prefix_str, pinfo->nd_opt_pi_prefix_len);
+
+/* eager switch code - end */
+
 			if (ntohl(pinfo->nd_opt_pi_valid_time) == 0xffffffff)
 			{		
 				if (!edefs || DFLT_AdvValidLifetime != 0xffffffff)
@@ -478,3 +525,56 @@ usage(void)
 	fprintf(stderr,"usage: %s %s\n", pname, usage_str);
 	exit(1);	
 }
+
+/* eager switch code - begin */
+
+void
+eager_switch(ra_record *last_ra)
+{
+        int i;
+        ra_record *first_ra, *cached_ra = NULL;
+        char command[256] = "";
+
+        for ( i = 0; i <= ra_cache_size - 1; i++ )
+        {
+                if ( ra_cache[i]->if_index == last_ra->if_index )
+                {
+                        cached_ra = ra_cache[i];
+                        break;
+                }
+        }
+        if ( cached_ra == NULL )
+        {
+                printf ("\nThis is the first RA on %s\n", last_ra->if_name);
+                first_ra = malloc(sizeof(ra_record));
+                memcpy(first_ra, last_ra, sizeof(ra_record));
+                ra_cache[ra_cache_size] = first_ra;
+                ra_cache_size++;
+        }
+        else
+        {
+                if ( strcmp(cached_ra->prefix, last_ra->prefix) )
+                {
+                        printf("\n- - Eager switching - - - - - - - - - - - - -\n");
+                        if ( strcmp(cached_ra->router_addr, last_ra->router_addr) )
+                        {
+                                printf("\nROUTER HAS CHANGED...\n");
+                                sprintf(command, "ip -6 route del ::/0 via %s", cached_ra->router_addr);
+                                system(command);
+                                printf("%s\n", command);
+                                strcpy(cached_ra->router_addr, last_ra->router_addr);
+                        }
+                        printf("\nPREFIX HAS CHANGED...\n");
+                        sprintf(command,"ip -6 route del %s dev %s", cached_ra->prefix, cached_ra->if_name);
+                        system(command);
+                        printf("%s\n", command);
+                        sprintf(command,"ip -6 addr flush dev %s to %s",cached_ra->if_name,cached_ra->prefix);
+                        system(command);
+                        printf("%s\n", command);
+                        strcpy(cached_ra->prefix, last_ra->prefix);
+                        printf("\n- - Eager switching done  - - - - - - - - - -\n");
+                }
+        }
+}
+
+/* eager switch code - end */
