diff -urN linux-2.6.19.7/net/ipv4/xfrm4_input.c linux-2.6.19.7-loopback/net/ipv4/xfrm4_input.c
--- linux-2.6.19.7/net/ipv4/xfrm4_input.c	2007-05-13 16:06:27.000000000 +0300
+++ linux-2.6.19.7-loopback/net/ipv4/xfrm4_input.c	2007-05-13 16:06:36.000000000 +0300
@@ -136,10 +136,8 @@
 	nf_reset(skb);
 
 	if (decaps) {
-		if (!(skb->dev->flags&IFF_LOOPBACK)) {
-			dst_release(skb->dst);
-			skb->dst = NULL;
-		}
+                dst_release(skb->dst);
+                skb->dst = NULL;
 		netif_rx(skb);
 		return 0;
 	} else {
diff -urN linux-2.6.19.7/net/ipv4/xfrm4_mode_beet.c linux-2.6.19.7-loopback/net/ipv4/xfrm4_mode_beet.c
--- linux-2.6.19.7/net/ipv4/xfrm4_mode_beet.c	2007-05-13 16:06:27.000000000 +0300
+++ linux-2.6.19.7-loopback/net/ipv4/xfrm4_mode_beet.c	2007-05-13 16:10:48.000000000 +0300
@@ -70,6 +70,8 @@
 	} else
 		BUG_ON(1);
 
+        skb->protocol = htons(ETH_P_IP);
+
 	return 0;
 }
 
diff -urN linux-2.6.19.7/net/ipv4/xfrm4_mode_tunnel.c linux-2.6.19.7-loopback/net/ipv4/xfrm4_mode_tunnel.c
--- linux-2.6.19.7/net/ipv4/xfrm4_mode_tunnel.c	2007-03-03 07:14:54.000000000 +0200
+++ linux-2.6.19.7-loopback/net/ipv4/xfrm4_mode_tunnel.c	2007-05-13 16:03:53.000000000 +0300
@@ -66,6 +66,8 @@
 	top_iph->daddr = x->id.daddr.a4;
 	top_iph->protocol = IPPROTO_IPIP;
 
+        skb->protocol = htons(ETH_P_IP);
+
 	memset(&(IPCB(skb)->opt), 0, sizeof(struct ip_options));
 	return 0;
 }
diff -urN linux-2.6.19.7/net/ipv6/xfrm6_input.c linux-2.6.19.7-loopback/net/ipv6/xfrm6_input.c
--- linux-2.6.19.7/net/ipv6/xfrm6_input.c	2007-03-03 07:14:54.000000000 +0200
+++ linux-2.6.19.7-loopback/net/ipv6/xfrm6_input.c	2007-05-13 16:04:36.000000000 +0300
@@ -103,10 +103,8 @@
 	nf_reset(skb);
 
 	if (decaps) {
-		if (!(skb->dev->flags&IFF_LOOPBACK)) {
-			dst_release(skb->dst);
-			skb->dst = NULL;
-		}
+                dst_release(skb->dst);
+                skb->dst = NULL;
 		netif_rx(skb);
 		return -1;
 	} else {
diff -urN linux-2.6.19.7/net/ipv6/xfrm6_mode_beet.c linux-2.6.19.7-loopback/net/ipv6/xfrm6_mode_beet.c
--- linux-2.6.19.7/net/ipv6/xfrm6_mode_beet.c	2007-05-13 16:06:27.000000000 +0300
+++ linux-2.6.19.7-loopback/net/ipv6/xfrm6_mode_beet.c	2007-05-13 16:11:42.000000000 +0300
@@ -130,6 +130,8 @@
 	} else
 		BUG_ON(1);
 
+        skb->protocol = htons(ETH_P_IPV6);
+
 	return 0;
 }
 
diff -urN linux-2.6.19.7/net/ipv6/xfrm6_mode_tunnel.c linux-2.6.19.7-loopback/net/ipv6/xfrm6_mode_tunnel.c
--- linux-2.6.19.7/net/ipv6/xfrm6_mode_tunnel.c	2007-03-03 07:14:54.000000000 +0200
+++ linux-2.6.19.7-loopback/net/ipv6/xfrm6_mode_tunnel.c	2007-05-13 16:05:42.000000000 +0300
@@ -65,6 +65,8 @@
 	top_iph->hop_limit = dst_metric(dst->child, RTAX_HOPLIMIT);
 	ipv6_addr_copy(&top_iph->saddr, (struct in6_addr *)&x->props.saddr);
 	ipv6_addr_copy(&top_iph->daddr, (struct in6_addr *)&x->id.daddr);
+        skb->protocol = htons(ETH_P_IPV6);
+
 	return 0;
 }
 
