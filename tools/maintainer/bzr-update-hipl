#!/bin/sh

set -e

PATH=/p/bin:$PATH

# Use abs dir names in TMP_DIR, WWW_DIR and OUTPUT_FILE
TMP_DIR=~/.bzr-hipl-cache
REVISION=trunk
WWW_DIR=/var/www/infrahip/html/hipl
OUTPUT_FILE=$WWW_DIR/hipl.tar.gz
CHANGE_LOG_FILE=/tmp/ChangeLog
VERSION=

# Update to the latest version and check out what patches need to be generated
#
if test -x  $TMP_DIR
then
    cd $TMP_DIR/hipl-bzr/$REVISION
    bzr update
else
    mkdir $TMP_DIR
    bzr init-repo hipl-bzr
    cd hipl-bzr
    bzr checkout file:///var/archive/hipl-bzr/$REVISION
    cd $REVISION
fi

VERSION=$(grep '^AC_INIT' configure.ac|cut -d'[' -f 3|cut -d']' -f1)

# Generate a ChangeLog file
#
bzr log > $CHANGE_LOG_FILE

# Make a HIP tarball
#
autoreconf --install
./configure --sysconfdir=/etc
make dist

# Add ChangeLog file and rename as "trunk"
tar xzf hipl-${VERSION}.tar.gz
mv hipl-${VERSION} trunk
cp $CHANGE_LOG_FILE trunk/doc
tar czf hipl.tar.gz trunk
chmod a+r hipl.tar.gz

# Move the tarball to the web
mv hipl.tar.gz $WWW_DIR

# Move the ChangeLog to web
#
mv $CHANGE_LOG_FILE $WWW_DIR

# Remove temporary files
rm -rf hipl-${VERSION} trunk

