# $USAGI: Makefile.in,v 1.34 2003/06/21 04:17:42 yoshfuji Exp $

# Copyright (C) 2000-2001 USAGI/WIDE Project.
# All rights reserved.
# 
# Redistribution and use in source and binary forms, with or without
# modification, are permitted provided that the following conditions
# are met:
# 1. Redistributions of source code must retain the above copyright
#    notice, this list of conditions and the following disclaimer.
# 2. Redistributions in binary form must reproduce the above copyright
#    notice, this list of conditions and the following disclaimer in the
#    documentation and/or other materials provided with the distribution.
# 3. Neither the name of the project nor the names of its contributors
#    may be used to endorse or promote products derived from this software
#    without specific prior written permission.
# 
# THIS SOFTWARE IS PROVIDED BY THE PROJECT AND CONTRIBUTORS ``AS IS'' AND
# ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
# IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
# ARE DISCLAIMED.  IN NO EVENT SHALL THE PROJECT OR CONTRIBUTORS BE LIABLE
# FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL
# DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS
# OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)
# HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT
# LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY
# OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF
# SUCH DAMAGE.

CC = @CC@
INSTALL = @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
INSTALL_SCRIPT = @INSTALL_SCRIPT@
INSTALL_DATA = @INSTALL_DATA@
INSTALL_LIBRARY = @INSTALL_LIBRARY@
INSTALL_DIR = @INSTALL_DIR@
LN_S = @LN_S@
PERL = @perl@
LORDER = @lorder@
CFLAGS = -D_LIBC_REENTRANT -D_IO_MTSAFE_IO -D_USAGI -D_USAGI_LIBINET6=$(usagi_libc) -D_GNU_SOURCE -DCOMPAT_RFC2292 -Iinclude \
		-D__ss_family=ss_family -D__ss_len=ss_len
DEFS = @DEFS@

usagi_libc=@usagi_libc@

CFLAGS += -Iinclude_glibc$(usagi_libc)

prefix = @prefix@
exec_prefix = @exec_prefix@
includedir = @includedir@
libdir = @libdir@
slibdir = @libdir@
mandir = @mandir@
man3dir = $(mandir)/man3

MODE=0644

A_LIBS = libinet6.a libinet6_p.a
LIBS = $(A_LIBS)
LIBOBJS = tempname.o
OBJS = usagi.o \
	getaddrinfo.o getnameinfo.o \
	ip6opt.o rthdr.o \
	ifaddrs.o ifnames.o \
	cmsg_nxthdr.o \
	rcmd.o rexec.o \
	sa_len.o

# BEGIN HIPL PATCH

# Note: -I.. is included because "tools/debug.h" is included; otherwise this
# won't build because there is also the linux/net/ipv6/hip/debug.h include.
#
CFLAGS += -g -DHIP_TRANSPARENT_API -I../linux/include -I../tools -I..
CFLAGS += -I../linux/net/ipv6/hip
OBJS += debug.o builder.o message.o getendpointinfo.o

# END HIPL PATCH

S_LIBS = $(patsubst %.a, %.so, $(A_LIBS))
SLIBS = $(S_LIBS)
LIBPOBJS = $(patsubst %.o, %.po, $(LIBOBJS))
POBJS = $(patsubst %.o, %.po, $(OBJS))

MAN3S = getifaddrs.3

.SUFFIXES: .o .po .so .a

.c.o:
	$(CC) $(CFLAGS) $(DEFS) -o $@ -c $<
.c.po:
	$(CC) -pg $(CFLAGS) $(DEFS) -o $@ -c $<

SUBTARGET = \
	include_glibc$(usagi_libc)_all \
	include_glibc$(usagi_libc)_includes \
	include_glibc$(usagi_libc)_install \
	include_glibc$(usagi_libc)_install-includes \
	include_glibc21_clean \
	include_glibc22_clean \
	include_glibc23_clean \
	include_glibc21_distclean \
	include_glibc22_distclean \
	include_glibc23_distclean

.PHONY: all shared includes install install-shared install-includes clean distclean \
	$(SUBTARGET)

all: includes include_glibc$(usagi_libc) $(LIBS)
shared: includes include_glibc$(usagi_libc) $(SLIBS)
includes: include_glibc$(usagi_libc)_includes
	$(MAKE) -C include_glibc$(usagi_libc) $(patsubst include_glibc$(usagi_libc)_%, %, $@)
	-if [ -d include ]; then	\
		rm -fr include;		\
	fi
	$(LN_S) -f include_glibc$(usagi_libc) include
install: all include_glibc$(usagi_libc)_install
	$(INSTALL_DIR) $(libdir)
	$(INSTALL_LIBRARY) $(LIBS) $(libdir)
	$(INSTALL_DIR) $(man3dir)
	$(INSTALL_DATA) $(MAN3S) $(man3dir)
install-shared: shared include_glibc$(usagi_libc)_install
	$(INSTALL_DIR) $(slibdir)
	$(INSTALL_LIBRARY) $(SLIBS) $(slibdir)
install-includes: include_glibc$(usagi_libc)_install-includes
clean: include_glibc21_clean include_glibc22_clean include_glibc23_clean
	-rm -f $(LIBS) $(SLIBS) $(OBJS) $(POBJS) $(LIBOBJS) $(LIBPOBJS)
distclean: clean include_glibc21_distclean include_glibc22_distclean include_glibc23_distclean
	-rm -f include
	-rm -f *.so *.a *.o *.po
	-rm -f config.status config.cache config.log config.h Makefile

$SUBTARGET:
	$(MAKE) -C include_glibc$(usagi_libc) $(patsubst include_glibc$(usagi_libc)_%, %, $@)

libinet6.so: $(OBJS) $(LIBOBJS)
	$(CC) -shared -o $@ `$(LORDER) $^ | tsort`
libinet6_p.so: $(POBJS) $(LIBPOBJS)
	$(CC) -shared -o $@ `$(LORDER) $^ | tsort`
libinet6.a: $(OBJS) $(LIBOBJS)
	$(AR) r $@ $^
libinet6_p.a: $(POBJS) $(LIBPOBJS)
	$(AR) r $@ $^

# BEGIN HIPL PATCH
builder.c:
	$(LN_S) -f ../linux/net/ipv6/hip/builder.c builder.c
builder.o: builder.c
debug.c:
	$(LN_S) -f ../tools/debug.c debug.c
debug.o: debug.c
message.c:
	$(LN_S) -f ../tools/message.c message.c
message.o: message.c
getendpointinfo.o: getendpointinfo.c
# END HIPL PATCH

tempname.o: tempname.c libc-compat.h
getaddrinfo.o: getaddrinfo.c libc-compat.h
getnameinfo.o: getnameinfo.c libc-compat.h
ip6opt.o: ip6opt.c libc-compat.h
rthdr.o: rthdr.c libc-compat.h
ifaddrs.o: ifaddrs.c libc-compat.h
ifnames.o: ifnames.c libc-compat.h

