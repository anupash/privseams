#!/bin/sh

# HOOK [match] TARGET
# HOOK ::= <INPUT|OUTPUT|FORWARD>
# match ::= src_hit [!] <hit value> --hi <file name>
#           -dst_hit [!] <hit>
#           -type [!] <hip packet type>
#           -i [!] <incoming interface>
#           -o [!] <outgoing interface>
#          -state [!] <state> --verify_responder --accept_mobile
# TARGET::= <ACCEPT|DROP>

#run with -H as first argument to stop all other traffic

#enable TCP port 22 (ssh) to and from the device
enable_ssh(){
#This must be delayed to give the hipfw some time to delete the rules
sleep 5
iptables -I INPUT 1 -p tcp --dport 22 -j ACCEPT
iptables -I OUTPUT 1 -p tcp --sport 22 -j ACCEPT
echo "Re-enabled SSH"
}


export PATH=.:../../firewall:$PWD/test/performance:$PWD/firewall:$PATH

RULE_FILE=/tmp/fw.tmp
TIMEOUT=0

ACCEPT_INIT_LIST=2001:77:9caf:f8c2:1191:29b5:583e:850
DROP_INIT_LIST=

RESP=2001:10:17e5:e586:5f1b:a01b:f5c9:f825


rm $RULE_FILE 2>/dev/null

for INIT in $ACCEPT_INIT_LIST
do
  echo "FORWARD -src_hit $INIT -dst_hit $RESP ACCEPT" >> $RULE_FILE
  echo "FORWARD -src_hit $RESP -dst_hit $INIT ACCEPT" >> $RULE_FILE
done

for INIT in $DROP_INIT_LIST
do
  echo "FORWARD -src_hit $INIT -dst_hit $RESP DROP"   >> $RULE_FILE
  echo "FORWARD -src_hit $RESP -dst_hit $INIT DROP"   >> $RULE_FILE
done

firewall.init
hipfw -k -b -m  $RULE_FILE $TIMEOUT $1
